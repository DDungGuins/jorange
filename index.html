<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¡°ë‘ì´ì˜ ë°”ëŒì¼ê¸° ë°•ë¬¼ê´€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #fff; margin: 0; overflow-x: hidden; font-family: sans-serif; }
        header { height: 110px; background: #1a1a1a; z-index: 40; position: relative; border-bottom: 1px solid #333; }

        #viewer-container {
            width: 100vw;
            height: calc(100vh - 110px);
            overflow: hidden;
            position: relative;
        }

        :fullscreen #viewer-container { height: 100vh; }
        :fullscreen header { display: none; }

        .comic-img { display: block; flex-shrink: 0; object-fit: contain; background: #000; }

        /* [1] ê°€ë¡œ ë§ì¶¤ (ì›¹íˆ°) */
        .mode-width { overflow-y: auto !important; display: block !important; scroll-behavior: smooth; }
        .mode-width .comic-img { width: 100vw; height: auto; }

        /* [2] ì„¸ë¡œ ë§ì¶¤ (í•œ ì¥ì”© ì˜†ìœ¼ë¡œ) */
        .mode-height { 
            display: flex !important; 
            flex-direction: row; 
            overflow-x: auto !important; 
            overflow-y: hidden !important; 
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }
        .mode-height .comic-img {
            height: 100%;
            width: 100vw;
            scroll-snap-align: center;
            scroll-snap-stop: always;
        }

        /* [3] ê¸°ë³¸ í¬ê¸° */
        .mode-original { overflow: auto !important; display: block !important; }
        .mode-original .comic-img { width: auto; max-width: 100vw; height: auto; margin: 0 auto; }

        .nav-input { background: #333; color: #fbbf24; border: 1px solid #444; width: 45px; text-align: center; border-radius: 4px; font-weight: bold; outline: none; }
        .bottom-nav { padding: 40px 0; background: #111; display: flex; justify-content: center; align-items: center; gap: 15px; border-top: 1px solid #222; }

        #viewer-container::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <header class="flex flex-col justify-center px-4">
        <div class="flex gap-2 mb-2">
            <select id="cat-select" class="flex-1 bg-[#2a2a2a] text-sm p-2 rounded border border-gray-700 outline-none">
                <option value="jorang">ì¡°ë‘ì´ì˜ ë°”ëŒì¼ê¸° (ë³¸í¸)</option>
                <option value="extra">ì¡°ë‘ì´ì˜ ë°”ëŒì¼ê¸° (ì™¸ì „)</option>
                <option value="kim">ê¹€êµ°ì˜ ì¼ê¸°</option>
                <option value="yeon">ë°”ëŒì˜ë‚˜ë¼ ì—° ì¼ê¸°</option>
            </select>
            <button onclick="toggleFullScreen()" class="bg-blue-700 px-4 py-1 rounded text-xs font-bold">ì „ì²´í™”ë©´</button>
        </div>
        
        <div class="flex justify-between items-center">
            <div class="flex gap-1" id="mode-buttons">
                <button onclick="setMode('width')" id="btn-width" class="bg-blue-600 px-2 py-1 rounded text-[10px] text-white">ê°€ë¡œ ë§ì¶¤</button>
                <button onclick="setMode('height')" id="btn-height" class="bg-gray-700 px-2 py-1 rounded text-[10px] text-white">ì„¸ë¡œ ë§ì¶¤</button>
                <button onclick="setMode('original')" id="btn-original" class="bg-gray-700 px-2 py-1 rounded text-[10px] text-white">ê¸°ë³¸ í¬ê¸°</button>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="changeEp(-1)" class="text-2xl px-1">â—€</button>
                <input type="number" id="jump-input-top" class="nav-input" value="1" onchange="jumpToEp(this.value)">
                <button onclick="changeEp(1)" class="text-2xl px-1">â–¶</button>
            </div>
        </div>
    </header>

    <main id="viewer-container" class="mode-width">
        <div id="viewer-inner" style="display: contents;"></div>
        <div id="bottom-controls" class="bottom-nav">
            <button onclick="changeEp(-1)" class="text-3xl px-4">â—€</button>
            <div class="flex items-center gap-1">
                <input type="number" id="jump-input-bottom" class="nav-input text-xl w-16 h-10" value="1" onchange="jumpToEp(this.value)">
                <span class="text-yellow-500 font-bold">í™”</span>
            </div>
            <button onclick="changeEp(1)" class="text-3xl px-4">â–¶</button>
        </div>
    </main>

    <div id="preloader" style="display:none;"></div>

    <script>
        let currentCat = 'jorang';
        let currentEp = 1;
        let db = {};
        let currentMode = 'width';
        let startX = 0;

        async function init() {
            try {
                const [jorang, extra, kim, yeon] = await Promise.all([
                    fetch('./file_list.json').then(res => res.json()),
                    fetch('./file_list_ì™¸ì „.json').then(res => res.json()),
                    fetch('./file_list_kim.json').then(res => res.json()),
                    fetch('./file_list_ë°”ëŒ_ì—°.json').then(res => res.json())
                ]);
                db = { jorang, extra, kim, yeon };
                render();
            } catch (e) { alert('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!'); }
        }

        // ì´ë¯¸ì§€ ê²½ë¡œ ë¦¬ìŠ¤íŠ¸ ìƒì„±ê¸°
        function getPaths(cat, ep) {
            const data = db[cat];
            if (!data) return [];
            
            if (cat === 'kim') {
                const pages = data[ep] || [];
                return pages.map(name => `./ê¹€êµ°ì˜ ì¼ê¸°/${name}`);
            } else if (cat === 'jorang') {
                return data[ep - 1] ? [`./${data[ep - 1]}`] : [];
            } else {
                const folder = cat === 'extra' ? 'ì¡°ë‘ì´ì˜ ë°”ëŒì¼ê¸° ì™¸ì „' : 'ë°”ëŒì˜ë‚˜ë¼ ì—° ì¼ê¸°';
                return data[ep - 1] ? [`./${folder}/${data[ep - 1]}`] : [];
            }
        }

        function render() {
            const inner = document.getElementById('viewer-inner');
            const container = document.getElementById('viewer-container');
            inner.innerHTML = '';
            
            const paths = getPaths(currentCat, currentEp);
            paths.forEach(path => {
                const img = document.createElement('img');
                img.src = path;
                img.className = "comic-img";
                inner.appendChild(img);
            });

            document.getElementById('jump-input-top').value = currentEp;
            document.getElementById('jump-input-bottom').value = currentEp;
            container.scrollTo(0, 0);

            // í˜„ì¬ ë Œë”ë§ ì§í›„ ë‹¤ìŒ í™” ë¯¸ë¦¬ ë¡œë“œ
            preloadNext();
        }

        // ğŸ’¡ í•µì‹¬ ê¸°ëŠ¥: ë‹¤ìŒ í™” ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
        function preloadNext() {
            const max = currentCat === 'kim' ? Object.keys(db.kim).length : db[currentCat].length;
            if (currentEp < max) {
                const nextPaths = getPaths(currentCat, currentEp + 1);
                const preloader = document.getElementById('preloader');
                // ê¸°ì¡´ í”„ë¦¬ë¡œë“œ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
                preloader.innerHTML = '';
                nextPaths.forEach(path => {
                    const img = new Image();
                    img.src = path;
                    preloader.appendChild(img);
                });
            }
        }

        document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
        document.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].clientX;
            const diffX = startX - endX;
            const container = document.getElementById('viewer-container');

            if (currentMode === 'height') {
                const isAtEnd = container.scrollLeft + container.offsetWidth >= container.scrollWidth - 10;
                const isAtStart = container.scrollLeft <= 10;
                if (Math.abs(diffX) > 100) {
                    if (diffX > 0 && isAtEnd) changeEp(1);
                    else if (diffX < 0 && isAtStart) changeEp(-1);
                }
            } else {
                if (Math.abs(diffX) > 100) {
                    if (diffX > 0) changeEp(1);
                    else if (diffX < 0) changeEp(-1);
                }
            }
        });

        function jumpToEp(val) {
            const max = currentCat === 'kim' ? Object.keys(db.kim).length : db[currentCat].length;
            let target = parseInt(val);
            if (isNaN(target) || target < 1) target = 1;
            if (target > max) target = max;
            currentEp = target;
            render();
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('viewer-container').className = `mode-${mode}`;
            document.querySelectorAll('#mode-buttons button').forEach(btn => {
                btn.className = "bg-gray-700 px-2 py-1 rounded text-[10px] text-white";
            });
            document.getElementById(`btn-${mode}`).className = "bg-blue-600 px-2 py-1 rounded text-[10px] text-white";
            render();
        }

        function changeEp(delta) {
            const max = currentCat === 'kim' ? Object.keys(db.kim).length : db[currentCat].length;
            const next = currentEp + delta;
            if (next >= 1 && next <= max) {
                currentEp = next;
                render();
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        document.getElementById('cat-select').onchange = (e) => {
            currentCat = e.target.value;
            currentEp = 1;
            render();
        };

        init();
    </script>
</body>
</html>
