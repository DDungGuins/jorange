<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>조랑이의 바람일기 박물관</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #fff; margin: 0; overflow-x: hidden; font-family: sans-serif; }
        header { height: 110px; background: #1a1a1a; z-index: 40; position: relative; border-bottom: 1px solid #333; }

        #viewer-container {
            width: 100vw;
            height: calc(100vh - 110px);
            overflow: hidden;
            position: relative;
        }

        :fullscreen #viewer-container { height: 100vh; }
        :fullscreen header { display: none; }

        .comic-img { display: block; flex-shrink: 0; object-fit: contain; background: #000; }

        /* [1] 가로 맞춤 (웹툰) */
        .mode-width { overflow-y: auto !important; display: block !important; scroll-behavior: smooth; }
        .mode-width .comic-img { width: 100vw; height: auto; }

        /* [2] 세로 맞춤 (한 장씩 옆으로) */
        .mode-height { 
            display: flex !important; 
            flex-direction: row; 
            overflow-x: auto !important; 
            overflow-y: hidden !important; 
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }
        .mode-height .comic-img {
            height: 100%;
            width: 100vw;
            scroll-snap-align: center;
            scroll-snap-stop: always;
        }

        /* [3] 기본 크기 */
        .mode-original { overflow: auto !important; display: block !important; }
        .mode-original .comic-img { width: auto; max-width: 100vw; height: auto; margin: 0 auto; }

        .ep-select { background: #333; color: #fbbf24; border: 1px solid #444; border-radius: 4px; font-weight: bold; outline: none; cursor: pointer; }
        .ep-select-top { max-width: 160px; font-size: 11px; padding: 2px 4px; }
        .ep-select-bottom { max-width: 320px; font-size: 15px; padding: 4px 8px; }
        .bottom-nav { padding: 40px 0; background: #111; display: flex; justify-content: center; align-items: center; gap: 15px; border-top: 1px solid #222; }

        #viewer-container::-webkit-scrollbar { display: none; }

        /* PC 사이드 네비게이션 */
        .side-nav {
            position: fixed;
            top: 110px;
            height: calc(100vh - 110px);
            width: 12%;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            font-size: 2.5rem;
            color: white;
            user-select: none;
        }
        .side-nav:hover { opacity: 1; background: rgba(0,0,0,0.35); }
        #nav-prev { left: 0; }
        #nav-next { right: 0; }
        :fullscreen .side-nav { top: 0; height: 100vh; }

        /* HD 버튼 스타일 */
        .btn-hd-active { background-color: #fbbf24 !important; color: #000 !important; font-weight: 800; border: 2px solid #fff; }
    </style>
</head>
<body>

    <header class="flex flex-col justify-center px-4">
        <div class="flex gap-2 mb-2">
            <select id="cat-select" class="flex-1 bg-[#2a2a2a] text-sm p-2 rounded border border-gray-700 outline-none">
                <option value="jorang">조랑이의 바람일기 (본편)</option>
                <option value="extra">조랑이의 바람일기 (외전)</option>
                <option value="kim">김군의 일기</option>
                <option value="yeon">바람의나라 연 일기</option>
            </select>
            <button id="btn-hd" onclick="toggleHD()" class="bg-gray-700 px-3 py-1 rounded text-xs font-bold transition-all">HD</button>
            <button onclick="toggleFullScreen()" class="bg-blue-700 px-3 py-1 rounded text-xs font-bold">전체화면</button>
        </div>
        
        <div class="flex justify-between items-center">
            <div class="flex gap-1" id="mode-buttons">
                <button onclick="setMode('width')" id="btn-width" class="bg-blue-600 px-2 py-1 rounded text-[10px] text-white">가로 맞춤</button>
                <button onclick="setMode('height')" id="btn-height" class="bg-gray-700 px-2 py-1 rounded text-[10px] text-white">세로 맞춤</button>
                <button onclick="setMode('original')" id="btn-original" class="bg-gray-700 px-2 py-1 rounded text-[10px] text-white">기본 크기</button>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="changeEp(-1)" class="text-2xl px-1">◀</button>
                <select id="jump-input-top" class="ep-select ep-select-top" onchange="jumpToEp(this.value)"></select>
                <button onclick="changeEp(1)" class="text-2xl px-1">▶</button>
            </div>
        </div>
    </header>

    <div id="nav-prev" class="side-nav" onclick="changeEp(-1)">◀</div>
    <div id="nav-next" class="side-nav" onclick="changeEp(1)">▶</div>

    <main id="viewer-container" class="mode-width">
        <div id="viewer-inner" style="display: contents;"></div>
        <div id="bottom-controls" class="bottom-nav">
            <button onclick="changeEp(-1)" class="text-3xl px-4">◀</button>
            <select id="jump-input-bottom" class="ep-select ep-select-bottom" onchange="jumpToEp(this.value)"></select>
            <button onclick="changeEp(1)" class="text-3xl px-4">▶</button>
        </div>
    </main>

    <div id="preloader" style="display:none;"></div>

    <script>
        let currentCat = localStorage.getItem('cat') || 'jorang';
        let currentEp = parseInt(localStorage.getItem('ep')) || 1;
        let db = {};
        let dbHD = {}; 
        let isHD = localStorage.getItem('hd') === 'true';
        let currentMode = localStorage.getItem('mode') || 'width';
        let startX = 0;

        async function init() {
            try {
                const [jorang, extra, kim, yeon, hdData] = await Promise.all([
                    fetch('./file_list.json').then(res => res.json()),
                    fetch('./file_list_외전.json').then(res => res.json()),
                    fetch('./file_list_kim.json').then(res => res.json()),
                    fetch('./file_list_바람_연.json').then(res => res.json()),
                    fetch('./file_list_hd.json').then(res => res.json()) 
                ]);
                db = { jorang, extra, kim, yeon };
                dbHD = hdData;
                document.getElementById('cat-select').value = currentCat;
                if (isHD) document.getElementById('btn-hd').className = "btn-hd-active px-3 py-1 rounded text-xs font-bold transition-all";
                document.getElementById('viewer-container').className = `mode-${currentMode}`;
                document.querySelectorAll('#mode-buttons button').forEach(btn => btn.className = "bg-gray-700 px-2 py-1 rounded text-[10px] text-white");
                document.getElementById(`btn-${currentMode}`).className = "bg-blue-600 px-2 py-1 rounded text-[10px] text-white";
                buildDropdown();
                render();
            } catch (e) { console.error(e); }
        }

        function toggleHD() {
            if (currentCat === 'jorang' || currentCat === 'extra') {
                isHD = !isHD;
                localStorage.setItem('hd', isHD);
                document.getElementById('btn-hd').className = isHD ? "btn-hd-active px-3 py-1 rounded text-xs font-bold transition-all" : "bg-gray-700 px-3 py-1 rounded text-xs font-bold transition-all";
                render();
            } else {
                alert('이 시리즈는 HD를 지원하지 않습니다.');
            }
        }

        function getPaths(cat, ep) {
            // ✅ HD 모드일 때 개별 폴더 매핑 로직
            if (isHD) {
                if (cat === 'jorang') {
                    let folder = "";
                    if (ep <= 50) folder = "조랑이의 바람일기 1~50(up)";
                    else if (ep <= 100) folder = "조랑이의 바람일기 51~100(up)";
                    else if (ep <= 150) folder = "조랑이의 바람일기 101~150(up)";
                    else folder = "조랑이의 바람일기 151~219(up)";
                    
                    const fileName = dbHD.jorang_hd[ep - 1];
                    return fileName ? [`./${folder}/${fileName}`] : [];
                } else if (cat === 'extra') {
                    const folder = "조랑이의 바람일기 외전(up)";
                    const fileName = dbHD.extra_hd[ep - 1];
                    return fileName ? [`./${folder}/${fileName}`] : [];
                }
            }

            // 원본 데이터 경로 로직 (유지)
            const data = db[cat];
            if (!data) return [];
            if (cat === 'kim') {
                const pages = data[ep] || [];
                return pages.map(name => `./김군의 일기/${name}`);
            } else if (cat === 'jorang') {
                return data[ep - 1] ? [`./${data[ep - 1]}`] : [];
            } else {
                const folder = cat === 'extra' ? '조랑이의 바람일기 외전' : '바람의나라 연 일기';
                return data[ep - 1] ? [`./${folder}/${data[ep - 1]}`] : [];
            }
        }

        function render() {
            const inner = document.getElementById('viewer-inner');
            const container = document.getElementById('viewer-container');
            inner.innerHTML = '';
            
            const paths = getPaths(currentCat, currentEp);
            paths.forEach(path => {
                const img = document.createElement('img');
                img.src = path;
                img.className = "comic-img";
                inner.appendChild(img);
            });

            document.getElementById('jump-input-top').value = currentEp;
            document.getElementById('jump-input-bottom').value = currentEp;
            localStorage.setItem('cat', currentCat);
            localStorage.setItem('ep', currentEp);
            container.scrollTo(0, 0);
            preloadNext();
        }

        function preloadNext() {
            const max = currentCat === 'kim' ? Object.keys(db.kim).length : db[currentCat].length;
            if (currentEp < max) {
                const nextPaths = getPaths(currentCat, currentEp + 1);
                const preloader = document.getElementById('preloader');
                preloader.innerHTML = '';
                nextPaths.forEach(path => {
                    const img = new Image();
                    img.src = path;
                    preloader.appendChild(img);
                });
            }
        }

        function getEpTitle(cat, ep) {
            if (cat === 'jorang') {
                const filename = (db.jorang[ep - 1] || '').split('/').pop();
                const m = filename.match(/바람일기 (.+)\.jpg$/i);
                return m ? m[1] : `${ep}화`;
            } else if (cat === 'extra') {
                const filename = db.extra[ep - 1] || '';
                const m = filename.match(/외전 (.+)\.jpg$/i);
                return m ? m[1] : `${ep}화`;
            } else if (cat === 'yeon') {
                const filename = db.yeon[ep - 1] || '';
                const m = filename.match(/일기 (.+)\.jpg$/i);
                return m ? m[1] : `${ep}화`;
            }
            return `${ep}화`;
        }

        function buildDropdown() {
            const max = currentCat === 'kim' ? Object.keys(db.kim).length : db[currentCat].length;
            const opts = Array.from({length: max}, (_, i) => {
                const ep = i + 1;
                return `<option value="${ep}">${getEpTitle(currentCat, ep)}</option>`;
            }).join('');
            document.getElementById('jump-input-top').innerHTML = opts;
            document.getElementById('jump-input-bottom').innerHTML = opts;
        }

        // 키보드 방향키
        document.addEventListener('keydown', e => {
            if (['INPUT', 'SELECT'].includes(document.activeElement.tagName)) return;
            if (e.key === 'ArrowLeft') changeEp(-1);
            else if (e.key === 'ArrowRight') changeEp(1);
        });

        document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
        document.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].clientX;
            const diffX = startX - endX;
            const container = document.getElementById('viewer-container');
            if (Math.abs(diffX) > 100) {
                if (currentMode === 'height') {
                    const isAtEnd = container.scrollLeft + container.offsetWidth >= container.scrollWidth - 10;
                    const isAtStart = container.scrollLeft <= 10;
                    if (diffX > 0 && isAtEnd) changeEp(1);
                    else if (diffX < 0 && isAtStart) changeEp(-1);
                } else {
                    if (diffX > 0) changeEp(1);
                    else if (diffX < 0) changeEp(-1);
                }
            }
        });

        function jumpToEp(val) {
            const max = currentCat === 'kim' ? Object.keys(db.kim).length : db[currentCat].length;
            let target = parseInt(val);
            if (isNaN(target) || target < 1) target = 1;
            if (target > max) target = max;
            currentEp = target;
            render();
        }

        function setMode(mode) {
            currentMode = mode;
            localStorage.setItem('mode', mode);
            document.getElementById('viewer-container').className = `mode-${mode}`;
            document.querySelectorAll('#mode-buttons button').forEach(btn => {
                btn.className = "bg-gray-700 px-2 py-1 rounded text-[10px] text-white";
            });
            document.getElementById(`btn-${mode}`).className = "bg-blue-600 px-2 py-1 rounded text-[10px] text-white";
            render();
        }

        function changeEp(delta) {
            const max = currentCat === 'kim' ? Object.keys(db.kim).length : db[currentCat].length;
            const next = currentEp + delta;
            if (next >= 1 && next <= max) {
                currentEp = next;
                render();
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        document.getElementById('cat-select').onchange = (e) => {
            currentCat = e.target.value;
            currentEp = 1;
            if (currentCat !== 'jorang' && currentCat !== 'extra') {
                isHD = false;
                document.getElementById('btn-hd').className = "bg-gray-700 px-3 py-1 rounded text-xs font-bold transition-all";
            }
            buildDropdown();
            render();
        };

        init();
    </script>
</body>
</html>
