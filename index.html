<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>조랑이의 바람일기 박물관</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #fff; margin: 0; touch-action: pan-y; overflow: hidden; }
        
        /* 헤더 스타일 */
        header { height: 110px; background: #1a1a1a; z-index: 50; }

        /* 메인 뷰어 컨테이너 */
        #viewer-container {
            width: 100vw;
            height: calc(100vh - 110px);
            overflow: hidden;
            position: relative;
            display: flex;
            transition: height 0.3s;
        }

        /* 전체화면 모드일 때 뷰어 높이 조정 */
        :fullscreen #viewer-container { height: 100vh; }
        :fullscreen header { display: none; }

        /* 이미지 공통 스타일 */
        .comic-img {
            display: block;
            flex-shrink: 0;
            object-fit: contain;
        }

        /* [1] 가로 맞춤: 가로 꽉 채우고 세로 스크롤 허용 */
        .mode-width { overflow-y: auto !important; display: block !important; }
        .mode-width .comic-img {
            width: 100vw;
            height: auto;
            max-height: none;
        }

        /* [2] 세로 맞춤: 세로 꽉 채우고 스크롤 없음 (다중 이미지는 가로 배치) */
        .mode-height { 
            display: flex !important; 
            flex-direction: row; 
            overflow-x: auto !important; 
            overflow-y: hidden !important; 
            scroll-snap-type: x mandatory;
        }
        .mode-height .comic-img {
            height: 100%;
            width: auto;
            max-width: 100vw;
            scroll-snap-align: center;
        }

        /* [3] 기본 크기: 원본 비율 유지, 스크롤 자유 */
        .mode-original { overflow: auto !important; display: block !important; }
        .mode-original .comic-img {
            width: auto;
            max-width: 100vw;
            height: auto;
            margin: 0 auto 10px;
        }

        /* 컨트롤러 UI */
        .btn-active { background-color: #2563eb !important; color: white; }
        .nav-btn { background-color: #374151; padding: 4px 8px; border-radius: 4px; font-size: 11px; transition: 0.2s; }
    </style>
</head>
<body>

    <header class="flex flex-col justify-center px-4 border-b border-gray-800">
        <div class="flex gap-2 mb-2">
            <select id="cat-select" class="flex-1 bg-[#2a2a2a] text-sm p-2 rounded border border-gray-700 outline-none">
                <option value="jorang">조랑이의 바람일기 (본편)</option>
                <option value="extra">조랑이의 바람일기 (외전)</option>
                <option value="kim">김군의 일기</option>
                <option value="yeon">바람의나라 연 일기</option>
            </select>
            <button onclick="toggleFullScreen()" class="bg-red-600 px-4 py-1 rounded text-xs font-bold">전체화면</button>
        </div>
        
        <div class="flex justify-between items-center">
            <div class="flex gap-1" id="mode-buttons">
                <button onclick="setMode('width')" id="btn-width" class="nav-btn btn-active">가로 맞춤</button>
                <button onclick="setMode('height')" id="btn-height" class="nav-btn">세로 맞춤</button>
                <button onclick="setMode('original')" id="btn-original" class="nav-btn">기본 크기</button>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="changeEp(-1)" class="text-2xl">◀</button>
                <span id="ep-info" class="font-bold text-yellow-500 min-w-[40px] text-center text-lg">1화</span>
                <button onclick="changeEp(1)" class="text-2xl">▶</button>
            </div>
        </div>
    </header>

    <main id="viewer-container" class="mode-width">
        </main>

    <script>
        let currentCat = 'jorang';
        let currentEp = 1;
        let db = {};
        let currentMode = 'width';

        // 터치 스와이프 변수
        let startX = 0;

        async function init() {
            try {
                const [jorang, extra, kim, yeon] = await Promise.all([
                    fetch('./file_list.json').then(res => res.json()),
                    fetch('./file_list_외전.json').then(res => res.json()),
                    fetch('./file_list_kim.json').then(res => res.json()),
                    fetch('./file_list_바람_연.json').then(res => res.json())
                ]);
                db = { jorang, extra, kim, yeon };
                render();
            } catch (e) { 
                console.error(e);
                alert('데이터 로드 실패! JSON 파일명과 경로를 확인하세요.'); 
            }
        }

        function render() {
            const container = document.getElementById('viewer-container');
            container.innerHTML = '';
            const data = db[currentCat];

            // 이미지 경로 및 목록 추출
            let imagePaths = [];
            if (currentCat === 'kim') {
                const pages = data[currentEp] || [];
                imagePaths = pages.map(name => `./김군의 일기/${name}`);
            } else if (currentCat === 'jorang') {
                imagePaths = [`./${data[currentEp - 1]}`];
            } else {
                const folder = currentCat === 'extra' ? '조랑이의 바람일기 외전' : '바람의나라 연 일기';
                imagePaths = [`./${folder}/${data[currentEp - 1]}`];
            }

            // 이미지 태그 생성 및 삽입
            imagePaths.forEach(path => {
                const img = document.createElement('img');
                img.src = path;
                img.className = "comic-img";
                container.appendChild(img);
            });

            document.getElementById('ep-info').innerText = `${currentEp}화`;
            container.scrollTo(0, 0); // 화 바뀔 때 스크롤 초기화
        }

        // 1. 화면 맞춤 모드 변경
        function setMode(mode) {
            currentMode = mode;
            const container = document.getElementById('viewer-container');
            container.className = `mode-${mode}`;
            
            // 버튼 디자인 변경
            document.querySelectorAll('#mode-buttons button').forEach(btn => btn.classList.remove('btn-active'));
            document.getElementById(`btn-${mode}`).classList.add('btn-active');
            
            // 렌더링 다시 해서 스크롤/슬라이드 속성 적용
            render();
        }

        // 2. 전체화면 (강제 가로회전 방지 및 비율 유지)
        function toggleFullScreen() {
            const doc = document.documentElement;
            if (!document.fullscreenElement) {
                if (doc.requestFullscreen) doc.requestFullscreen();
                else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen(); // Safari 지원
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // 3. 화 이동
        function changeEp(delta) {
            const max = currentCat === 'kim' ? Object.keys(db.kim).length : db[currentCat].length;
            const next = currentEp + delta;
            if (next >= 1 && next <= max) {
                currentEp = next;
                render();
            }
        }

        // 4. 모바일 스와이프 (이전/다음화)
        // 세로 맞춤 모드에서는 이미지 간 슬라이드를 방해하지 않기 위해 상단 헤더 근처에서만 작동하게 하거나 임계값 조절
        document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
        document.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].clientX;
            const diff = startX - endX;
            
            // 가로 맞춤일 때만 화 이동 스와이프 활성화 (세로 맞춤은 이미지 슬라이드용으로 양보)
            if (currentMode === 'width' && Math.abs(diff) > 100) {
                if (diff > 0) changeEp(1);
                else changeEp(-1);
            }
        });

        document.getElementById('cat-select').onchange = (e) => {
            currentCat = e.target.value;
            currentEp = 1;
            render();
        };

        init();
    </script>
</body>
</html>
